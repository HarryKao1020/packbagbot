#telegramåŸºç¤æ©Ÿèƒ½
import telegram
from telegram import ReplyKeyboardMarkup, ReplyKeyboardRemove, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Updater, Filters, ConversationHandler, Dispatcher, CallbackQueryHandler , CommandHandler, MessageHandler

#å…¶é¤˜å¥—ä»¶
from os import path
from selenium import webdriver
import configparser
import logging
import random

import db
# import botFunction
# from botFunction import *
from place.PAPI import getNear, getPlace, getSearch

# from flask import Flask, request, render_template

#===============================================
#===============================================
#===============================================

#Load data from config.ini file
config = configparser.ConfigParser()
config.read('config.ini')

# Enable logging
logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
                    level=logging.INFO)
logger = logging.getLogger(__name__)

# Initial bot by Telegram access token
bot = telegram.Bot(token=(config['TELEGRAM']['ACCESS_TOKEN']))

#===============================================
#===================å¤©æ°£ç”¨åƒæ•¸===================
#===============================================
city_code_list={  #å„ç¸£å¸‚ID
    "åŸºéš†":"10017", "å°åŒ—":"63", "æ–°åŒ—":"65", "æ¡ƒåœ’":"68", "æ–°ç«¹":"10018", "è‹—æ —":"10005", "å°ä¸­":"66", "å—æŠ•":"10008", "å½°åŒ–":"10007", "é›²æ—":"10009", "å˜‰ç¾©":"10020", "å°å—":"67", "é«˜é›„":"64", "å±æ±":"10013", "å°æ±":"10014", "èŠ±è“®":"10015", "å®œè˜­":"10002",
}
weatherDeatil = ''
weatherAll = ''

NAMING, DIRECTION, COUNTY, TYPE_ONE, TYPE_TWO, TYPE_THREE, TRAFFIC, SEARCH_PLACE, PLACE, PLACE_TWO,HISTORY = range(11)
travelname = {} #ç´€éŒ„ä½¿ç”¨è€…ç•¶å‰è¡Œç¨‹åç¨±
cntplace = {} #ç´€éŒ„ä½¿ç”¨è€…å®‰æ’æ™¯é»æ•¸é‡
tmpplace = {} #æš«å­˜ä½¿ç”¨è€…é¸æ“‡æ™¯é»
placebuttontmp = {} #æš«å­˜ä½¿ç”¨è€…æŒ‰éˆ•è³‡æ–™
tmpplacedetail = {} #ç´€éŒ„åœ°é»è©³ç´°è³‡è¨Š
tmpregion = {} #ç´€éŒ„åœ°å€
tmptypes= {} #ç´€éŒ„é¡å‹æ¬¡æ•¸
tmpcounty= {} #ç´€éŒ„ç¸£å¸‚

#===============================================
#===================ç¶²é ç”¨åƒæ•¸===================
#===============================================
webUserID = ''     #webUserID = UserID
webtravelname = '' #webtravelname = è‡ªè¡Œå‘½åçš„è¡Œç¨‹å
webRandom = ''     #webRandom = é¿å…è¡Œç¨‹åé‡è¤‡
webUrl = ''        #webUrl = ç”¢ç”Ÿçš„ç¶²å€ (UserID+è‡ªè¡Œå‘½åçš„æ™¯é»+äº‚æ•¸)
detailUrl = ''     #detailUrl = ç”¨ä¾†ç”¢ç”Ÿè©³ç´°æ™¯é»è³‡è¨ŠURL

#================ bot ä¸»ç¨‹å¼ ================
conv_handler = ConversationHandler(
        entry_points=[CommandHandler('letsgo', naming)],

        states={
            NAMING:[MessageHandler(Filters.text, start),]
            ,
            DIRECTION: [
                        CallbackQueryHandler(selcounty),
                        ],
            COUNTY: [ 
                # CallbackQueryHandler(botFunction.start, pattern='^' + str(estartstart) + '$'),
                CallbackQueryHandler(start, pattern='^' + str(restart) + '$'),
                        CallbackQueryHandler(button),
                        MessageHandler(Filters.regex('^(/chooseOK)$'), type_one),
                        MessageHandler(Filters.regex('^(/return)$'), start),
                        MessageHandler(Filters.regex('^(Ok)$'), type_one),
                        MessageHandler(Filters.regex('^(OK)$'), type_one)],
            TYPE_ONE: [
                        MessageHandler(Filters.text, type_two),],
            TYPE_TWO:[
                        CommandHandler('done', traffic),
                        MessageHandler(Filters.text, type_three),],
            TYPE_THREE:[
                        CommandHandler('done', traffic),
                        MessageHandler(Filters.text, traffic),],
            TRAFFIC:[
                    MessageHandler(Filters.regex('^(å¤§çœ¾é‹è¼¸ğŸšŒ)$'), traffic2),
                    MessageHandler(Filters.regex('^(å®¢é‹ğŸšŒ)$'), place_fork),
                    MessageHandler(Filters.regex('^(ç«è»ŠğŸš‚)$'), place_fork),
                    MessageHandler(Filters.regex('^(é«˜éµğŸš…)$'), place_fork),
                    MessageHandler(Filters.regex('^(å…¶ä»–ğŸš‚)$'), place_fork),
            ],
            SEARCH_PLACE:[CommandHandler('restart', restart),
                CommandHandler('go', place_choose),
                CommandHandler('done', place_choose),
                MessageHandler(Filters.text, search_placedetail),
                CallbackQueryHandler(search_confirmbutton, pattern='^' + str(search_confirmbutton) + '$'),
                
            ],
            PLACE:[CommandHandler('restart', restart),
                CallbackQueryHandler(returnplace, pattern='^(ä¸Šä¸€é )$'),
                CallbackQueryHandler(confirmbutton, pattern='^' + str(confirmbutton) + '$'),
                CallbackQueryHandler(placedetail),
                CommandHandler('next', place_choose),
                CommandHandler('done', done),
                MessageHandler(Filters.regex('^(ä¸‹ä¸€å€‹)$'), place_choose),
                MessageHandler(Filters.regex('^(å®Œæˆ)$'), done)],
        },
        fallbacks=[CommandHandler('restart', restart),MessageHandler(Filters.regex('^Done$'), done)]
    )

history_handler = ConversationHandler(
    entry_points = [CommandHandler('History', history)],
    states = {
        HISTORY:[CallbackQueryHandler(history_output),]
    },
    fallbacks=[]
)

# New a dispatcher for bot
dispatcher = Dispatcher(bot, None)

# Add handler for handling message, there are many kinds of message. For this handler, it particular handle text
# message.
dispatcher.add_handler(conv_handler)
dispatcher.add_handler(history_handler)
dispatcher.add_handler(CommandHandler('help', help_handler))
dispatcher.add_handler(CommandHandler('start', greet))
dispatcher.add_handler(CommandHandler('restart', restart))
dispatcher.add_handler(MessageHandler(Filters.text, warnnn))
#================================================
updater = Updater(token=(config['TELEGRAM']['ACCESS_TOKEN']))
updater.start_polling() #è®“ç¨‹å¼æŒçºŒé‹è¡Œ
updater.idle()


